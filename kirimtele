#!/bin/bash

# Mendapatkan lokasi direktori asli script (resolve symlink)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

CONFIG_FILE="$SCRIPT_DIR/config"

# Fungsi untuk setup konfigurasi (jika config kosong/belum diedit)
setup_config() {
    echo "âš ï¸  Konfigurasi belum diatur di file 'config'."
    read -p "Masukkan Telegram Bot Token: " TOKEN
    read -p "Masukkan Chat ID tujuan: " CHAT_ID
    
    # Update file config
    # Menggunakan sed untuk mengganti placeholder atau isi file
    echo "TOKEN=\"$TOKEN\"" > "$CONFIG_FILE"
    echo "CHAT_ID=\"$CHAT_ID\"" >> "$CONFIG_FILE"
    echo "âœ… Konfigurasi disimpan di $CONFIG_FILE"
}

if [ "$1" == "--reset" ]; then
    rm -f "$CONFIG_FILE"
    echo "Konfigurasi di-reset."
    exit 0
fi

FILE_PATH="$1"

# Cek apakah argumen pertama adalah file
if [ -f "$FILE_PATH" ]; then
    # Mode Kirim File dengan Caption
    shift
    CAPTION="$*"
    
    # Load config
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    fi

    # Cek apakah config masih default/kosong
    if [ -z "$TOKEN" ] || [[ "$TOKEN" == *"GANTI_DENGAN"* ]]; then
        setup_config
        source "$CONFIG_FILE"
    fi

    echo "ğŸ“¤ Sedang mengirim file: '$FILE_PATH' ..."
    [ ! -z "$CAPTION" ] && echo "ğŸ’¬ Caption: $CAPTION"
    echo "---------------------------------------------------"

    RESPONSE=$(curl --progress-bar -F chat_id="$CHAT_ID" -F document=@"$FILE_PATH" -F caption="$CAPTION" "https://api.telegram.org/bot$TOKEN/sendDocument")
else
    # Jika tidak ada argumen sama sekali, minta input file (perilaku lama)
    if [ -z "$FILE_PATH" ]; then
        echo "ğŸ’¡ Tips: Anda bisa Drag & Drop file ke terminal sekarang."
        read -p "ğŸ“‚ Masukkan path file (atau ketik pesan): " INPUT
        INPUT=$(echo "$INPUT" | tr -d "'\"")
        
        if [ -f "$INPUT" ]; then
            FILE_PATH="$INPUT"
            # Lanjut ke pengiriman file (tanpa caption karena interaktif)
            CAPTION=""
        else
            # Input manual bukan file, anggap pesan teks
            MESSAGE="$INPUT"
            FILE_PATH="[TEXT]"
        fi
    else
        # Argumen ada tapi bukan file, anggap pesan teks
        MESSAGE="$*"
        FILE_PATH="[TEXT]"
    fi

    # Load config
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    fi

    # Cek apakah config masih default/kosong
    if [ -z "$TOKEN" ] || [[ "$TOKEN" == *"GANTI_DENGAN"* ]]; then
        setup_config
        source "$CONFIG_FILE"
    fi

    if [ "$FILE_PATH" == "[TEXT]" ]; then
        echo "ğŸ“¤ Sedang mengirim pesan teks ..."
        echo "---------------------------------------------------"
        RESPONSE=$(curl -s -F chat_id="$CHAT_ID" -F text="$MESSAGE" "https://api.telegram.org/bot$TOKEN/sendMessage")
    else
        echo "ğŸ“¤ Sedang mengirim file: '$FILE_PATH' ..."
        echo "---------------------------------------------------"
        RESPONSE=$(curl --progress-bar -F chat_id="$CHAT_ID" -F document=@"$FILE_PATH" "https://api.telegram.org/bot$TOKEN/sendDocument")
    fi
fi

echo "---------------------------------------------------"

# Cek sukses simpel (cek apakah ada "ok":true di response JSON)
# Menggunakan single quote di luar agar double quote di dalam terbaca sebagai string literal
if [[ $RESPONSE == *'"ok":true'* ]]; then
    if [ "$FILE_PATH" == "[TEXT]" ]; then
        echo "âœ… SUKSES: Pesan berhasil dikirim!"
    else
        echo "âœ… SUKSES: File berhasil dikirim!"
    fi
    
    # Ambil Message ID untuk keperluan fitur delete
    MSG_ID=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['result']['message_id'])" 2>/dev/null)
    
    if [ ! -z "$MSG_ID" ]; then
        # Simpan ke history (Format: MSG_ID|TIMESTAMP|FILENAME|CHAT_ID)
        HISTORY_FILE="$HOME/.telechat_history"
        echo "$MSG_ID|$(date +%s)|$FILE_PATH|$CHAT_ID" >> "$HISTORY_FILE"
    fi
    
    # Contextual Hint
    echo -e "\nğŸ’¡ Tips: Salah kirim? Ketik \033[1;33mhapustele\033[0m untuk menghapus pesan ini."
else
    echo "âŒ GAGAL: Terjadi kesalahan saat mengirim."
    echo "Respon API: $RESPONSE"
fi
