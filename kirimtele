#!/bin/bash

# Mendapatkan lokasi direktori asli script (resolve symlink)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

CONFIG_FILE="$SCRIPT_DIR/config"

# Fungsi untuk setup konfigurasi
setup_config() {
    echo "‚ö†Ô∏è  Konfigurasi belum diatur di file 'config'."
    read -p "Masukkan Telegram Bot Token: " TOKEN
    read -p "Masukkan Chat ID tujuan: " CHAT_ID
    
    echo "TOKEN=\"$TOKEN\"" > "$CONFIG_FILE"
    echo "CHAT_ID=\"$CHAT_ID\"" >> "$CONFIG_FILE"
    echo "‚úÖ Konfigurasi disimpan di $CONFIG_FILE"
}

if [ "$1" == "--reset" ]; then
    rm -f "$CONFIG_FILE"
    echo "Konfigurasi di-reset."
    exit 0
fi

# Load config
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# Cek dependensi: curl
if ! command -v curl &> /dev/null; then
    echo "‚ùå Error: 'curl' tidak ditemukan."
    
    # Deteksi distro
    install_cmd="sudo apt update && sudo apt install -y curl"
    if [ -f /etc/os-release ]; then
        os_info=$(cat /etc/os-release | tr '[:upper:]' '[:lower:]')
        if [[ "$os_info" == *"arch"* ]] || [[ "$os_info" == *"cachy"* ]]; then
            install_cmd="sudo pacman -S --noconfirm curl"
        elif [[ "$os_info" == *"fedora"* ]]; then
            install_cmd="sudo dnf install -y curl"
        fi
    fi

    read -p "‚ùì Ingin menginstallnya secara otomatis? (y/n): " confirm
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        echo "üöÄ Menjalankan: $install_cmd"
        eval $install_cmd
        if command -v curl &> /dev/null; then
            echo "‚úÖ Berhasil menginstall 'curl'."
        else
            echo "‚ùå Gagal menginstall. Silakan install manual."
            exit 1
        fi
    else
        echo "üí° Silakan install secara manual dengan:"
        echo "   $install_cmd"
        exit 1
    fi
fi

# Cek config
if [ -z "$TOKEN" ] || [[ "$TOKEN" == *"GANTI_DENGAN"* ]]; then
    setup_config
    source "$CONFIG_FILE"
fi

# Variabel State
MODE="TEXT"
FILES_TO_SEND=()
MESSAGE=""
CAPTION=""

# -------------------------------------------------------------
# LOGIC PARSING ARGUMEN
# -------------------------------------------------------------

# Jika ada argumen command line
if [ -n "$1" ]; then
    if [ -f "$1" ]; then
        MODE="SINGLE_FILE"
        FILES_TO_SEND=("$1")
        shift
        CAPTION="$*"
    else
        MODE="TEXT"
        MESSAGE="$*"
    fi
else
    # Jika tidak ada argumen, masuk mode interaktif
    echo "üí° Tips: Anda bisa Drag & Drop file ke terminal sekarang."
    echo "   (Anda juga bisa menambahkan komentar/caption setelah file)"
    read -p "üìÇ Masukkan path file (atau ketik pesan): " INPUT
    
    # Gunakan Python untuk parsing input agar aman terhadap quotes (Drag & Drop)
    PYTHON_PARSER="
import sys, shlex, os

try:
    input_str = sys.argv[1]
    tokens = shlex.split(input_str)
    
    if not tokens:
        print('TEXT')
        sys.exit(0)

    files = []
    others = []
    
    for t in tokens:
        # Cek apakah token adalah file valid
        if os.path.isfile(t):
            files.append(t)
        else:
            others.append(t)
    
    if not files:
        # Tidak ada file ditemukan, anggap semua text
        print('TEXT')
    else:
        # Ada file, pisahkan file dan caption
        print('FILES_WITH_CAPTION')
        for f in files:
            print(f)
        print('---END_OF_FILES---')
        # Gabungkan sisa token menjadi caption
        print(' '.join(others))

except Exception:
    # Fallback jika parsing error
    print('TEXT')
"
    # Jalankan parser
    PARSED_OUTPUT=$(python3 -c "$PYTHON_PARSER" "$INPUT")
    
    # Baca baris pertama untuk tipe
    DETECTED_TYPE=$(echo "$PARSED_OUTPUT" | head -n 1)
    
    if [ "$DETECTED_TYPE" == "FILES_WITH_CAPTION" ]; then
        MODE="MULTI_FILES"
        STATE="FILES"
        
        # Loop output python baris per baris (skip baris pertama)
        while IFS= read -r line; do
            # Skip baris pertama (TYPE)
            [[ "$line" == "FILES_WITH_CAPTION" ]] && continue
            
            if [ "$STATE" == "FILES" ]; then
                if [ "$line" == "---END_OF_FILES---" ]; then
                    STATE="CAPTION"
                    continue
                fi
                FILES_TO_SEND+=("$line")
            elif [ "$STATE" == "CAPTION" ]; then
                if [ -z "$CAPTION" ]; then
                    CAPTION="$line"
                else
                    CAPTION="$CAPTION"$'
'"$line"
                fi
            fi
        done <<< "$PARSED_OUTPUT"
        
    else
        MODE="TEXT"
        MESSAGE="$INPUT"
    fi
fi

# -------------------------------------------------------------
# FUNGSI PENGIRIMAN
# -------------------------------------------------------------

send_text() {
    local txt="$1"
    echo "üì§ Sedang mengirim pesan teks ..."
    echo "---------------------------------------------------"
    curl -s -F chat_id="$CHAT_ID" -F text="$txt" "https://api.telegram.org/bot$TOKEN/sendMessage"
}

send_file() {
    local fpath="$1"
    local capt="$2"
    echo "üì§ Sedang mengirim file: '$fpath' ..."
    [ -n "$capt" ] && echo "üí¨ Caption: $capt"
    echo "---------------------------------------------------"
    
    if [ -n "$capt" ]; then
        curl --progress-bar -F chat_id="$CHAT_ID" -F document=@"$fpath" -F caption="$capt" "https://api.telegram.org/bot$TOKEN/sendDocument"
    else
        curl --progress-bar -F chat_id="$CHAT_ID" -F document=@"$fpath" "https://api.telegram.org/bot$TOKEN/sendDocument"
    fi
}

save_to_history() {
    local response="$1"
    local filename="$2"
    
    # Ambil Message ID
    MSG_ID=$(echo "$response" | python3 -c "import sys, json; print(json.load(sys.stdin).get('result', {}).get('message_id', ''))" 2>/dev/null)
    
    if [ -n "$MSG_ID" ]; then
        # Sanitize filename (ganti | dengan _ agar tidak merusak format history)
        safe_filename=$(echo "$filename" | tr '|' '_')
        HISTORY_FILE="$HOME/.telechat_history"
        echo "$MSG_ID|$(date +%s)|$safe_filename|$CHAT_ID" >> "$HISTORY_FILE"
    fi
}

# -------------------------------------------------------------
# EKSEKUSI PENGIRIMAN
# -------------------------------------------------------------

if [ "$MODE" == "TEXT" ]; then
    RESPONSE=$(send_text "$MESSAGE")
    if [[ $RESPONSE == *'"ok":true'* ]]; then
        echo "‚úÖ SUKSES: Pesan berhasil dikirim!"
        save_to_history "$RESPONSE" "[TEXT] $MESSAGE"
    else
        echo "‚ùå GAGAL: $RESPONSE"
    fi

elif [ "$MODE" == "SINGLE_FILE" ]; then
    RESPONSE=$(send_file "${FILES_TO_SEND[0]}" "$CAPTION")
    if [[ $RESPONSE == *'"ok":true'* ]]; then
        echo "‚úÖ SUKSES: File berhasil dikirim!"
        save_to_history "$RESPONSE" "${FILES_TO_SEND[0]}"
    else
        echo "‚ùå GAGAL: $RESPONSE"
    fi

elif [ "$MODE" == "MULTI_FILES" ]; then
    count=0
    for f in "${FILES_TO_SEND[@]}"; do
        # Kirim caption HANYA pada file pertama
        if [ $count -eq 0 ]; then
            CURRENT_CAPTION="$CAPTION"
        else
            CURRENT_CAPTION=""
        fi
        
        RESPONSE=$(send_file "$f" "$CURRENT_CAPTION")
        
        if [[ $RESPONSE == *'"ok":true'* ]]; then
            echo "‚úÖ SUKSES: File '$(basename "$f")' berhasil dikirim!"
            save_to_history "$RESPONSE" "$f"
        else
            echo "‚ùå GAGAL kirim '$f': $RESPONSE"
        fi
        echo "---------------------------------------------------"
        count=$((count+1))
    done
fi

echo -e "\nüí° Tips: Salah kirim? Ketik \033[1;33mhapustele\033[0m untuk menghapus pesan ini."
